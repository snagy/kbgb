!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e={pickedKeys:[],renderData:{keys:{},case:{},mats:{},outlines:{}}},t={keyDims:[18,18],switchCutout:[14,14],base1U:[19.05,19.05],bezelGap:1.05,bezelThickness:5,bezelCornerFillet:.5,keyShape:"square",drawCase:!0};function n(e,t,n,o){let a=t.x*o.z-o.x*t.z;if(a<BABYLON.Epsilon)return null;let r=e.x*t.x+e.z*t.z,l=n.x*o.x+n.z*o.z;return new BABYLON.Vector3((o.z*r-t.z*l)/a,0,(t.x*l-o.x*r)/a)}function o(e,t,o,a,r){let l=r.subtract(a),i=n(e,o,a,new BABYLON.Vector3(l.z,0,-l.x).normalize());if(i){let e=i.subtract(a).lengthSquared();if(e>BABYLON.Epsilon&&e<l.lengthSquared()-BABYLON.Epsilon)return i}return null}function a(e,t){for(let n=0;n<t.length;n++){let o=t[n],a=t[(n+1)%t.length].subtract(o).normalize(),r=new BABYLON.Vector3(a.z,0,-a.x),l=e.subtract(o).normalize();if(BABYLON.Vector3.Dot(l,r)>BABYLON.Epsilon)return!1}return!0}function r(e){let t=Math.acos(e.x);return e.z<0&&(t=2*Math.PI-t),t}function l(e,t,n){var o,a=(e.z-n.z)*(t.x-n.x),r=(e.x-n.x)*(t.z-n.z),l=a-r;if(a>0){if(r<=0)return l;o=a+r}else{if(!(a<0))return l;if(r>=0)return l;o=-(a+r)}var i=33306690738754716e-32*o;return l>=i||l<=-i?l:0}function i(e){var t=e.length;if(t<3){for(var n=new Array(t),o=0;o<t;++o)n[o]=o;return 2===t&&e[0].x===e[1].x&&e[0].z===e[1].z?[0]:n}var a=new Array(t);for(o=0;o<t;++o)a[o]=o;a.sort((function(t,n){var o=e[t].x-e[n].x;return o||e[t].z-e[n].z}));var r=[a[0],a[1]],i=[a[0],a[1]];for(o=2;o<t;++o){for(var s=a[o],d=e[s],c=r.length;c>1&&l(e[r[c-2]],e[r[c-1]],d)<=0;)c-=1,r.pop();for(r.push(s),c=i.length;c>1&&l(e[i[c-2]],e[i[c-1]],d)>=0;)c-=1,i.pop();i.push(s)}n=new Array(i.length+r.length-2);for(var u=0,B=(o=0,r.length);o<B;++o)n[u++]=r[o];for(var h=i.length-2;h>0;--h)n[u++]=i[h];let p=[];for(const t of n)p.unshift(e[t]);return p}function s(e,t,o,a,l){let i=[];l||(l=4);for(let a=0;a<e.length;a++){let d=e[a],c=e[(a+1)%e.length],u=e[(a-1+e.length)%e.length],B=c.subtract(d).normalize(),h=d.subtract(u).normalize(),p=new BABYLON.Vector3(B.z,0,-B.x),b=new BABYLON.Vector3(h.z,0,-h.x),L=d.add(b.scale(t)),f=d.add(p.scale(t)),m=n(L,b,f,p);if(null!==m)if(o){let e=o,t=n(L.add(b.scale(-e)),b,f.add(p.scale(-e)),p),a=r(b),d=r(p);d<a&&(d+=2*Math.PI);let c=(d-a)/l;for(let n=0;n<=l;n++)i.push(t.add((s=a+c*n,new BABYLON.Vector3(Math.cos(s),0,Math.sin(s))).scale(e)))}else i.push(m);else i.push(L),i.push(f)}var s;return a&&i.push(i[0]),i}function d(t,n){let o=e.renderData.mats;o[t]=new BABYLON.PBRMetallicRoughnessMaterial(t,e.scene),o[t].metallic=0,o[t].roughness=1,o[t].baseColor=n,o[t].environmentTexture=e.hdrTexture}function c(){e.canvas=document.getElementById("renderCanvas"),e.engine=new BABYLON.Engine(e.canvas,!0),e.scene=function(){const t=e.engine;var n=new BABYLON.Scene(t),o=new BABYLON.ArcRotateCamera("Camera",-Math.PI/2,0,10,new BABYLON.Vector3(0,0,0),n);return o.setTarget(BABYLON.Vector3.Zero()),o.attachControl(e.canvas,!1),e.camera=o,e.hdrTexture=BABYLON.CubeTexture.CreateFromPrefilteredData("assets/environment.dds",n),e.currentSkybox=n.createDefaultSkybox(e.hdrTexture,!0,(n.activeCamera.maxZ-n.activeCamera.minZ)/2,.3),n}()}function u(){let t=e.renderData.keys,n=e.renderData.outlines,o=e.renderData.mats;for(const[t,o]of Object.entries(n))e.scene.removeMesh(o);for(const a of e.pickedKeys)if(t[a]){let r=t[a];n[a]=BABYLON.MeshBuilder.CreateRibbon(a+"outline",{pathArray:[s(r.outline,.1,.1,!0),s(r.outline,.5,.5,!0)]},e.scene),n[a].material=o.keySel,n[a].translate(new BABYLON.Vector3(0,10.5,0),1,BABYLON.Space.LOCAL)}else console.log("picked nonexistant key")}function B(){const n=e.scene,r=e.boardData,l=e.renderData.keys,d=e.renderData.mats;if("convex"==r.caseType){let e=[];for(let[t,n]of Object.entries(l))for(let t of n.outline)e.push(t);if(r.outline=i(e),r.forceSymmetrical){let t=.5*(r.layout.bounds.maxs[0]-r.layout.bounds.mins[0])+r.layout.bounds.mins[0];for(let n of r.outline)e.push(new BABYLON.Vector3(t-(n.x-t),n.y,n.z));r.outline=i(e)}}else{let e=r.layout.bounds;r.outline=[new BABYLON.Vector3(e.mins[0],0,e.mins[1]),new BABYLON.Vector3(e.maxs[0],0,e.mins[1]),new BABYLON.Vector3(e.maxs[0],0,e.maxs[1]),new BABYLON.Vector3(e.mins[0],0,e.maxs[1])]}let c=e.renderData.case,u=[s(r.outline,t.bezelGap,t.bezelCornerFillet,!1)],B=s(r.outline,t.bezelGap+t.bezelThickness,t.bezelThickness,!1,8);c.edge&&n.removeMesh(c.edge),t.drawCase&&(c.edge=BABYLON.MeshBuilder.CreatePolygon("edge",{shape:B,depth:9,holes:u,updatable:!0},n),c.edge.material=d.case),c.bottom&&n.removeMesh(c.bottom),t.drawCase&&(c.bottom=BABYLON.MeshBuilder.CreatePolygon("bottom",{shape:B,depth:3,updatable:!0},n),c.bottom.translate(new BABYLON.Vector3(0,-9,0),1,BABYLON.Space.LOCAL),c.bottom.material=d.case);let h={},p=[];for(const[e,t]of Object.entries(l))h[t.keyGroupId]||(h[t.keyGroupId]=[]),h[t.keyGroupId].push(t);for(const[e,n]of Object.entries(h)){for(const e of n){e.outlineLines=[],e.parsedOutlineLines={};for(let t=0;t<e.bezelHole.length;t++){let n=e.bezelHole[t],o=e.bezelHole[(t+1)%e.bezelHole.length];e.outlineLines.push([n,o])}for(const[t,n]of Object.entries(e.overlappingKeys))for(let t=e.outlineLines.length-1;t>=0;t--){let r=e.outlineLines[t],l=r[1].subtract(r[0]),i=new BABYLON.Vector3(l.z,0,-l.x).normalize(),s=a(r[0],n.bezelHole),d=a(r[1],n.bezelHole);if(s){d&&e.outlineLines.splice(t,1);let a=1e5,l=null;for(let e=0;e<n.bezelHole.length;e++){let t=o(r[0],0,i,n.bezelHole[e],n.bezelHole[(e+1)%n.bezelHole.length]);if(t){let e=t.subtract(r[0]).lengthSquared();e>BABYLON.Epsilon&&e<a&&(a=e,l=t)}}l&&(r[0]=l)}else if(d){let e=r[0].subtract(r[1]),t=new BABYLON.Vector3(e.z,0,-e.x).normalize(),a=1e5,l=null;for(let e=0;e<n.bezelHole.length;e++){let i=o(r[1],0,t,n.bezelHole[e],n.bezelHole[(e+1)%n.bezelHole.length]);if(i){let e=i.subtract(r[1]).lengthSquared();e>BABYLON.Epsilon&&e<a&&(a=e,l=i)}}l&&(r[1]=l)}}}let e=t.bezelGap*t.bezelGap+BABYLON.Epsilon;for(const t of n){t.visitedForOutline=!0;let n=t.outlineLines.length;for(let o=0;o<n;o++){let n=t.outlineLines[o],a=n[1].subtract(n[0]),r=a.length();if(r<BABYLON.Epsilon)continue;let l=a.normalizeFromLength(r);for(const[a,i]of Object.entries(t.overlappingKeys)){if(i.visitedForOutline)continue;let a=i.outlineLines.length;for(let s=0;s<a;s++){let a=i.outlineLines[s],d=a[1].subtract(a[0]),c=d.length();if(c<BABYLON.Epsilon)continue;let u=d.normalizeFromLength(c),B=BABYLON.Vector3.Dot(u,l);if(B<BABYLON.Epsilon-1||B>1-BABYLON.Epsilon){let d=n[0].subtract(a[0]),h=BABYLON.Vector3.Dot(d,u);if(a[0].add(u.scale(h)).subtract(n[0]).lengthSquared()<e)if(B<BABYLON.Epsilon-1)overlapFunc(s,c,r,a,u,h,i.outlineLines,i.parsedOutlineLines),overlapFunc(o,r,c,n,l,h,t.outlineLines,t.parsedOutlineLines);else if(B>1-BABYLON.Epsilon){if(h>BABYLON.Epsilon){let e=c-h;t.parsedOutlineLines[o]||e>BABYLON.Epsilon&&(t.parsedOutlineLines[o]=!0,t.outlineLines.push([n[0].add(l.scale(e)),n[1]]))}if(h<BABYLON.Epsilon){let e=-h;t.parsedOutlineLines[o]||e<r-BABYLON.Epsilon&&(t.parsedOutlineLines[o]=!0,t.outlineLines.push([n[0],n[0].add(l.scale(e))]))}}}}}}}let r=null,l=-1,i=!1;for(const e of n){for(let t=0;t<e.outlineLines.length;t++)if(!e.parsedOutlineLines[t]){r=e,l=t;break}if(l>=0)break}let d=[];for(;null!=r&&l>=0;){r.parsedOutlineLines[l]=!0;let e=r.outlineLines[l];if(i){let t=e[0];e[0]=e[1],e[1]=t}d.push(e[0]),l=-1;let t=1e6,n=(n,o,a)=>{let s=e[1].subtract(n[0]).lengthSquared();s<t&&(t=s,r=o,l=a,i=!1),s=e[1].subtract(n[1]).lengthSquared(),s<t&&(t=s,r=o,l=a,i=!0)};for(let e=0;e<r.outlineLines.length;e++)r.parsedOutlineLines[e]||n(r.outlineLines[e],r,e);for(const[e,t]of Object.entries(r.overlappingKeys))for(let e=0;e<t.outlineLines.length;e++)t.parsedOutlineLines[e]||n(t.outlineLines[e],t,e)}p.push(s(d,0,t.bezelCornerFillet,!1))}c.bezel&&n.removeMesh(c.bezel),t.drawCase&&(c.bezel=BABYLON.MeshBuilder.CreatePolygon("bezel",{shape:B,depth:7.5,holes:p},n),c.bezel.translate(new BABYLON.Vector3(0,7.5,0),1,BABYLON.Space.LOCAL),c.bezel.material=d.case)}function h(){!function(){const n=e.scene,o=e.boardData;let a=[1e5,1e5],r=[-1e5,-1e5],l=[],i=e.renderData.keys;for(const[e,t]of Object.entries(i))t.keycap&&n.removeMesh(t.keycap);i=e.renderData.keys=[];let s=0;for(const[d,c]of Object.entries(o.layout.keys)){i[d]||(i[d]={keyGroupId:null,id:d,mins:[1e5,1e5],maxs:[-1e5,-1e5],bezelMins:[1e5,1e5],bezelMaxs:[-1e5,-1e5],overlappingKeys:{}});let u=i[d],B=[(t.keyDims[0]+t.base1U[0]*(c.width-1))/2,(t.keyDims[1]+t.base1U[1]*(c.height-1))/2],h=[c.x*t.base1U[0]+B[0],-(c.y*t.base1U[1]+B[1])],p=(new BABYLON.Vector3(h[0],0,h[1]),BABYLON.Matrix.Identity());p=p.multiply(BABYLON.Matrix.Translation(h[0],0,h[1])),0!=c.rotation_angle&&(p=p.multiply(BABYLON.Matrix.Translation(-c.rotation_x*t.base1U[0],0,c.rotation_y*t.base1U[1])),p=p.multiply(BABYLON.Matrix.RotationY(c.rotation_angle*Math.PI/180)),p=p.multiply(BABYLON.Matrix.Translation(c.rotation_x*t.base1U[0],0,-c.rotation_y*t.base1U[1]))),u.outline=[BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(-B[0],0,-B[1]),p),BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(B[0],0,-B[1]),p),BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(B[0],0,B[1]),p),BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(-B[0],0,B[1]),p)],u.keycap&&n.removeMesh(u.keycap),t.keyShape&&(u.keycap=BABYLON.MeshBuilder.CreatePolygon(d,{shape:u.outline,depth:7,updatable:!1},n),u.keycap.translate(new BABYLON.Vector3(0,10.5,0),1,BABYLON.Space.LOCAL),c.matName&&e.renderData.mats[c.matName]&&(u.keycap.material=e.renderData.mats[c.matName])),u.bezelHole=[BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(-B[0]-t.bezelGap,0,-B[1]-t.bezelGap),p),BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(B[0]+t.bezelGap,0,-B[1]-t.bezelGap),p),BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(B[0]+t.bezelGap,0,B[1]+t.bezelGap),p),BABYLON.Vector3.TransformCoordinates(new BABYLON.Vector3(-B[0]-t.bezelGap,0,B[1]+t.bezelGap),p)],l.push(u.bezelHole);for(let e of u.bezelHole)u.bezelMins[0]=Math.min(u.bezelMins[0],e.x),u.bezelMaxs[0]=Math.max(u.bezelMaxs[0],e.x),u.bezelMins[1]=Math.min(u.bezelMins[1],e.z),u.bezelMaxs[1]=Math.max(u.bezelMaxs[1],e.z);for(let e of u.outline)u.mins[0]=Math.min(u.mins[0],e.x),u.maxs[0]=Math.max(u.maxs[0],e.x),u.mins[1]=Math.min(u.mins[1],e.z),u.maxs[1]=Math.max(u.maxs[1],e.z);a[0]=Math.min(u.mins[0],a[0]),r[0]=Math.max(u.maxs[0],r[0]),a[1]=Math.min(u.mins[1],a[1]),r[1]=Math.max(u.maxs[1],r[1]);let b=function(e,t,n,o){if(t.bezelMins[0]+BABYLON.Epsilon>o.bezelMaxs[0]||o.bezelMins[0]+BABYLON.Epsilon>t.bezelMaxs[0]||t.bezelMins[1]+BABYLON.Epsilon>o.bezelMaxs[1]||o.bezelMins[1]+BABYLON.Epsilon>t.bezelMaxs[1])return!1;let a=(e,t)=>{for(let n=0;n<e.bezelHole.length;n++){let o=e.bezelHole[(n+1)%e.bezelHole.length].subtract(e.bezelHole[n]),a=!0,r=!0;for(let l=0;l<t.bezelHole.length;l++){let i=BABYLON.Vector3.Dot(o,t.bezelHole[l].subtract(e.bezelHole[n]));r&=i>-BABYLON.Epsilon,a&=i<BABYLON.Epsilon}if(r||a)return!0}return!1},r=a(t,o);if(r||(r=a(o,t)),r)if(t.overlappingKeys[o.id]=o,o.overlappingKeys[t.id]=t,t.keyGroupId&&o.keyGroupId){let e=t.keyGroupId,n=o.keyGroupId;for(const[t,o]of Object.entries(i))o.keyGroupId==n&&(o.keyGroupId=e)}else t.keyGroupId?o.keyGroupId=t.keyGroupId:o.keyGroupId?t.keyGroupId=o.keyGroupId:t.keyGroupId=o.keyGroupId=s++};for(const[e,t]of Object.entries(i))e!=d&&b(c,u,o.layout.keys[e],t);u.keyGroupId||(u.keyGroupId=s++)}o.layout.bounds={mins:a,maxs:r},u()}(),B()}function p(){fetch("testkbs/basis-mono.kle").then((e=>e.json())).then((t=>{let n=e.renderData.mats,o={};o.meta=t.meta,o.case=t.case,o.layout={keys:{}};let a=0;for(let e of t.keys)e.id="key"+a++,n[e.color]||d(e.color,BABYLON.Color3.FromHexString(e.color)),e.matName=e.color,o.layout.keys[e.id]=e;e.boardData=o,function(){let t=e.renderData.mats,n="keySel";t[n]=new BABYLON.StandardMaterial(n,e.scene),t[n].diffuseColor=new BABYLON.Color3(0,0,0),t[n].emissiveColor=new BABYLON.Color3(1,0,0),t[n].specularColor=new BABYLON.Color3(0,0,0);let o="case";t.case=new BABYLON.PBRMetallicRoughnessMaterial(o,e.scene),t.case.metallic=1,t.case.roughness=.8,t.case.baseColor=new BABYLON.Color3(.6,.6,.6),t.case.environmentTexture=e.hdrTexture,d("key",new BABYLON.Color3(.9,.9,.9))}(),h(),function(){const t=e.boardData;e.camera.setTarget(new BABYLON.Vector3(t.layout.bounds.mins[0]+(t.layout.bounds.maxs[0]-t.layout.bounds.mins[0])/2,0,t.layout.bounds.mins[1]+(t.layout.bounds.maxs[1]-t.layout.bounds.mins[1])/2)),e.camera.alpha=-Math.PI/2,e.camera.beta=0,e.camera.radius=300}()}))}const b={addButton:function(e,t,n){n=n||{};var o=BABYLON.GUI.Button.CreateSimpleButton("button",e);return o.top="0px",o.left="0px",o.width=n.width?n.width:"60px",o.height=n.height?n.height:".4",o.cornerRadius=5,o.thickness=2,o.children[0].color="#DFF9FB",o.children[0].fontSize=24,o.color="#FF7979",o.background="#EB4D4B",o.onPointerClickObservable.add(t),o},addLabel:function(e){var t=new BABYLON.GUI.TextBlock;return t.width="80px",t.height=".9",t.text=e,t.color="white",t.fontSize=24,t},addKeyActionButton:function(t,n){return b.addButton(t,(function(){for(let t of e.pickedKeys){let o=e.boardData.layout.keys[t];n(o)}h()}))},modes:{key:{add:function(){let t=new BABYLON.GUI.StackPanel;t.height=".2",t.isPointerBlocker=!0,t.isVertical=!1,t.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM,t.addControl(b.addLabel("Pos: ")),t.addControl(b.addKeyActionButton("◄",(e=>e.x-=.25))),t.addControl(b.addKeyActionButton("▲",(e=>e.y-=.25))),t.addControl(b.addKeyActionButton("▼",(e=>e.y+=.25))),t.addControl(b.addKeyActionButton("►",(e=>e.x+=.25))),t.addControl(b.addLabel("Rot: ")),t.addControl(b.addKeyActionButton("⤹",(e=>e.rotation_angle-=5))),t.addControl(b.addKeyActionButton("⤸",(e=>e.rotation_angle+=5))),t.addControl(b.addLabel("W: ")),t.addControl(b.addKeyActionButton("⬌",(e=>e.width+=.25))),t.addControl(b.addKeyActionButton("⬄",(e=>e.width-=.25))),t.addControl(b.addLabel("H: ")),t.addControl(b.addKeyActionButton("⬍",(e=>e.height+=.25))),t.addControl(b.addKeyActionButton("⇳",(e=>e.height-=.25))),e.screengui.addControl(t),b.activeModeCtrl=t}},case:{add:function(){let t=new BABYLON.GUI.StackPanel;t.height=".2",t.isPointerBlocker=!0,t.isVertical=!1,t.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM,t.addControl(b.addLabel("Type: "));var n=function(t,n){var o=new BABYLON.GUI.RadioButton;o.width="20px",o.height="20px",o.color="white",o.background="green",o.onIsCheckedChangedObservable.add((function(n){n&&(e.boardData.caseType=t,B())}));var a=BABYLON.GUI.Control.AddHeader(o,t,"100px",{isHorizontal:!0,controlFirst:!0});a.height="30px",n.addControl(a)};let o=new BABYLON.GUI.StackPanel;o.height="1",o.width="200px",o.isVertical=!0,n("rectangle",o),n("convex",o),n("concave",o),t.addControl(o);var a=new BABYLON.GUI.Checkbox;a.width="20px",a.height="20px",a.isChecked=!1,a.color="green",a.onIsCheckedChangedObservable.add((function(t){e.boardData.forceSymmetrical=t,B()})),t.addControl(b.addLabel("SYM: ")),t.addControl(a),e.screengui.addControl(t),b.activeModeCtrl=t}}},setGUIMode:function(t){b.activeModeCtrl&&e.screengui.removeControl(b.activeModeCtrl),b.modes[t]&&b.modes[t].add()},addModeGUI:function(){let t=new BABYLON.GUI.StackPanel;t.height=".1",t.isPointerBlocker=!0,t.isVertical=!1,t.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,t.addControl(b.addButton("layout",(()=>{b.setGUIMode("key")}),{height:"1",width:"120px"})),t.addControl(b.addButton("case",(()=>{b.setGUIMode("case")}),{height:"1",width:"120px"})),t.addControl(b.addButton("pcb",(()=>{b.setGUIMode("pcb")}),{height:"1",width:"120px"})),t.addControl(b.addButton("deets",(()=>{b.setGUIMode("details")}),{height:"1",width:"120px"})),b.modeCtrl=t,e.screengui.addControl(t)}};window.addEventListener("DOMContentLoaded",(function(){c(),e.screengui=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("screenUI"),b.addModeGUI(),e.engine.runRenderLoop((function(){e.scene.render()})),p(),window.addEventListener("resize",(function(){e.engine.resize()})),window.addEventListener("keydown",(n=>{"i"==n.key&&(e.scene.debugLayer.isVisible()?e.scene.debugLayer.hide():e.scene.debugLayer.show()),"k"==n.key&&(t.keyShape=t.keyShape?null:"square",h()),"c"==n.key&&(t.drawCase=!t.drawCase,h())}))})),window.addEventListener("click",(function(t){const n=e.scene;var o=n.pick(n.pointerX,n.pointerY);o&&o.pickedMesh&&e.boardData.layout.keys[o.pickedMesh.name]&&(t.metaKey||t.ctrlKey?e.pickedKeys.indexOf(o.pickedMesh.name)>0?e.pickedKeys.splice(e.pickedKeys.indexOf(o.pickedMesh.name),1):e.pickedKeys.push(o.pickedMesh.name):e.pickedKeys=[o.pickedMesh.name],console.log("picked key "+o.pickedMesh.name),u())}))}));
//# sourceMappingURL=pack.js.map
